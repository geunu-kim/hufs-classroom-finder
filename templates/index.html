<!DOCTYPE html>
<html lang="ko">
<head>
  <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
  <meta charset="UTF-8">
  <title>HUFSpace</title>
  <link rel="icon" href="/static/Symbol.png" type="image/png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="manifest" href="/static/manifest-v2.json">
  <style>
    @font-face {
        font-family: 'HUFSFont';
        src: url('/static/HUFSFontM.ttf') format('truetype');
        font-weight: normal;
        font-style: normal;
    }

    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      background-image: url('https://i.pinimg.com/736x/55/b8/5c/55b85c12335b0b2fcdcbb49acfb025ae.jpg'); /* User's newest preferred image */
      background-size: cover;
      background-position: center;
      font-family: 'HUFSFont', 'Noto Sans KR', sans-serif; /* Apply the new font */
      color: white;
    }

    /* .background-img removed */

    /* .bg-blur removed */

    .overlay {
      background: transparent; /* Removed dark overlay */
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
    }

    .content {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 40px 20px;
      text-align: center;
    }

    h1 {
      font-size: 48px;
      margin-bottom: 10px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
      color: rgb(0, 45, 86); /* HUFS NAVY */
    }
    .gold-text {
      color: rgb(141, 113, 80); /* HUFS GOLD */
    }
    .semester-text {
      display: block;
      margin-top: 5px; /* Adjust as needed */
    }

    p.subtitle {
      font-size: 18px;
      margin-bottom: 20px;
      opacity: 0.9;
      text-shadow: 0 1px 3px rgba(0,0,0,0.5);
      color: rgb(0, 45, 86); /* HUFS NAVY */
      font-weight: 700; /* Make it bolder */
    }

    .search-container {
      background: rgba(255, 255, 255, 0.95); /* Slightly less transparent */
      color: #333;
      border-radius: 20px; /* Slightly more rounded */
      padding: 30px 40px; /* More padding */
      width: 100%;
      max-width: 900px;
      box-shadow: 0 10px 40px 0 rgba(0, 0, 0, 0.2); /* Softer, larger shadow */
      backdrop-filter: blur(5px); /* Add a subtle blur effect */
      margin-bottom: 20px; /* Added spacing */
    }
    
    .controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1rem;
        align-items: flex-end;
        margin-bottom: 1.5rem;
    }

    .control-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        text-align: left;
    }

    .control-group label {
        font-weight: 700;
        color: #444;
        font-size: 0.9rem;
        padding-left: 5px;
    }

    select, button {
      padding: 14px 18px; /* More padding */
      border-radius: 10px; /* Slightly more rounded */
      border: 1px solid #e0e0e0; /* Lighter border */
      font-size: 17px; /* Slightly larger font */
      width: 100%;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05); /* Subtle shadow */
      background-color: #ffffff; /* Ensure white background for selects */
      color: #333;
    }

    button#search-btn { /* Target specific search button */
      background: linear-gradient(45deg, rgb(0, 45, 86), rgb(0, 60, 110)); /* HUFS NAVY gradient */
      color: white;
      cursor: pointer;
      transition: all 0.3s ease; /* Smoother transition */
      border: none;
      font-weight: 700;
      box-shadow: 0 4px 15px rgba(0, 45, 86, 0.4); /* More prominent shadow */
      padding: 15px 20px; /* More padding */
      border-radius: 12px; /* More rounded */
      font-size: 18px; /* Larger font */
      font-family: 'HUFSFont', 'Noto Sans KR', sans-serif; /* Apply the new font */
    }

    button#search-btn:hover {
      background: linear-gradient(45deg, rgb(0, 60, 110), rgb(0, 45, 86)); /* Reverse gradient on hover */
      box-shadow: 0 6px 20px rgba(0, 45, 86, 0.6); /* Enhanced shadow on hover */
      transform: translateY(-2px); /* Subtle lift effect */
    }

    .building-card {
        background-color: #f8f8f8; /* Lighter background */
        border: 1px solid #eee; /* Softer border */
        border-radius: 12px; /* More rounded */
        padding: 15px 10px; /* Adjusted padding */
        cursor: pointer;
        transition: all 0.3s ease; /* Smoother transition */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        flex: 0 0 calc(33.33% - 0.66rem); /* Three columns, accounting for gap */
        max-width: calc(33.33% - 0.66rem); /* Ensure max width for three columns */
        white-space: nowrap; /* Prevent text wrapping within buttons */
        text-align: center;
        color: #555; /* Softer text color */
        font-weight: 600; /* Slightly bolder font */
        box-shadow: 0 4px 10px rgba(0,0,0,0.08); /* Softer shadow */
    }

    .building-card:hover {
        background-color: #e8e8e8; /* Lighter hover background */
        box-shadow: 0 6px 15px rgba(0,0,0,0.12); /* Enhanced hover shadow */
        transform: translateY(-2px); /* Subtle lift effect */
    }

    .building-card.selected {
        background: linear-gradient(45deg, rgb(0, 45, 86), rgb(0, 60, 110)); /* HUFS NAVY gradient */
        color: white;
        border-color: rgb(0, 45, 86); /* Matching border color */
        box-shadow: 0 4px 15px rgba(0, 45, 86, 0.4); /* Prominent shadow */
    }
    #building-checkboxes {
        display: flex;
        flex-wrap: wrap; /* Allow items to wrap to the next line */
        gap: 1rem;
        margin-top: 1rem;
        /* Removed overflow-x: auto as it's no longer needed for horizontal scrolling */
        justify-content: center; /* Center items in the container */
        padding-bottom: 5px; /* Add some padding for scrollbar */
    }
    #results {
        /* Removed grid properties */
        display: flex; /* To stack floor-rows vertically */
        flex-direction: column;
        align-items: center; /* Center the floor-rows */
        margin-top: 2rem; /* Add some top margin */
        width: 100%;
        max-width: 900px; /* Match search container width */
    }
    .floor-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, 280px); /* Changed */
        gap: 1.5rem;
        margin-top: 1rem;
        width: 100%;
        max-width: 900px;
        justify-content: center; /* Added */
    }
    .result-item {
        background: #ffffff; /* Clean white background */
        color: #333;
        padding: 1.2rem 1.8rem; /* More padding */
        border-radius: 12px; /* More rounded */
        /* margin-bottom: 1rem; Removed, replaced by grid gap */
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        box-shadow: 0 6px 20px rgba(0,0,0,0.08); /* Softer, larger shadow */
        transition: all 0.3s ease; /* Smoother transition */
        animation: fadeIn 0.5s ease-in-out;
    }
    .result-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.12); /* Enhanced hover shadow */
    }
    .classroom-name {
        font-weight: 700;
        font-size: 1.3rem; /* Slightly larger font */
        color: rgb(0, 45, 86); /* HUFS NAVY */
        margin-bottom: 0.6rem;
    }
    .next-class {
        font-size: 1rem; /* Slightly larger font */
        color: #666; /* Softer text color */
        text-align: left;
        width: 100%;
    }
    .next-class-time {
        font-weight: 700;
        color: rgb(0, 100, 180); /* A lighter blue that complements HUFS NAVY */
    }
    .floor-separator {
        height: 1px;
        margin-top: 2rem;
        margin-bottom: 1.5rem;
        border: 0;
        background-image: linear-gradient(to right, rgba(141, 113, 80, 0), rgba(141, 113, 80, 0.75), rgba(141, 113, 80, 0));
        width: 100%;
    }
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    #share-all-btn {
      margin-top: 20px;
      margin-bottom: 20px; /* Added spacing */
      padding: 15px 20px;
      border-radius: 12px;
      background: #FEE500;
      color: #000000;
      font-weight: 700;
      font-size: 18px;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      width: 100%;
      max-width: 900px;
    }
    #share-all-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }
    .footer {
      color: black;
      text-align: center;
      padding: 20px;
      font-size: 0.9rem;
      position: relative;
      z-index: 1;
      margin-top: 40px; /* Add some space above the footer */
      text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Styles for the new occupancy popup */
    .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    .popup {
        background: white;
        padding: 25px 30px;
        border-radius: 15px;
        box-shadow: 0 5px 25px rgba(0,0,0,0.2);
        width: 90%;
        max-width: 400px;
        text-align: center;
        color: #333;
    }
    .popup h2 {
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 1.4rem;
        font-weight: 700;
    }
    .popup p {
        margin-bottom: 25px;
        font-size: 1rem;
        color: #666;
    }
    .popup-options {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 25px;
    }
    .popup-option {
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 1rem;
        font-weight: 600;
    }
    .popup-option.selected {
        background-color: rgb(0, 45, 86);
        color: white;
        border-color: rgb(0, 45, 86);
    }
    .popup-option.span-two-columns {
        grid-column: span 2;
    }
    .popup-submit {
        width: 100%;
        padding: 15px;
        border-radius: 10px;
        border: none;
        background: linear-gradient(45deg, rgb(0, 45, 86), rgb(0, 60, 110));
        color: white;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    .popup-submit:hover {
        background: linear-gradient(45deg, rgb(0, 60, 110), rgb(0, 45, 86));
    }
    .occupancy-info {
        font-size: 1rem;
        color: #666;
        text-align: left;
        width: 100%;
        margin-top: 0.6rem;
    }
    .occupancy-count {
        font-weight: 700;
        color: rgb(0, 100, 180); /* Same as .next-class-time */
    }
    .use-classroom-btn {
        margin-top: 1rem;
        padding: 10px 15px;
        width: 100%;
        border-radius: 8px;
        border: none;
        background-color: #eef5ff;
        color: #0056b3;
        font-weight: 700;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    .use-classroom-btn:hover {
        background-color: #dbeaff;
    }
  </style>
</head>

<body>
  <script>
    Kakao.init('7c1ad92f3918941cd8d0e30a84325209');
  </script>
  <div class="overlay"></div>
  <div class="content">
    <h1>HUFS<span class="gold-text">pace</span></h1>
    <p class="subtitle">í˜„ì¬ ë¹„ì–´ ìˆëŠ” ê°•ì˜ì‹¤ì„ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”.<br><span class="semester-text">[2025 - 2í•™ê¸°]</span></p>

    <div class="search-container">
        <div class="controls">
            <div class="control-group">
                <label for="day-select">ê³µê°• ìš”ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</label>
                <select id="day-select">
                    <option value="ì›”">ì›”ìš”ì¼</option>
                    <option value="í™”">í™”ìš”ì¼</option>
                    <option value="ìˆ˜">ìˆ˜ìš”ì¼</option>
                    <option value="ëª©">ëª©ìš”ì¼</option>
                    <option value="ê¸ˆ">ê¸ˆìš”ì¼</option>
                </select>
            </div>
            <div class="control-group">
                <label>ê³µê°• ì‹œê°„ëŒ€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="start-hour-select" aria-label="ì‹œì‘ ì‹œê°„"></select>
                    <select id="start-minute-select" aria-label="ì‹œì‘ ë¶„"></select>
                    <span>~</span>
                    <select id="end-hour-select" aria-label="ëë‚˜ëŠ” ì‹œê°„"></select>
                    <select id="end-minute-select" aria-label="ëë‚˜ëŠ” ë¶„"></select>
                </div>
            </div>
        </div>
        <div id="building-controls" class="control-group" style="margin-bottom: 1.5rem;">
            <label>ê²€ìƒ‰í•  ê±´ë¬¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”. (ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ ì „ì²´ ê±´ë¬¼ì´ ì„ íƒë©ë‹ˆë‹¤.)</label>
            <div id="building-checkboxes">
                <!-- ê±´ë¬¼ ì²´í¬ë°•ìŠ¤ëŠ” JavaScriptë¡œ ìƒì„± -->
            </div>
        </div>
        <button id="search-btn">ë¹ˆ ê°•ì˜ì‹¤ ì°¾ê¸°</button>
    </div>
    <ins class="kakao_ad_area" style="display:none;"
    data-ad-unit = "DAN-lHBg2akHRG7kZiQ3"
    data-ad-width = "320"
    data-ad-height = "50"></ins>
    <div id="results">
        <!-- ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
    </div>
    <button id="share-all-btn" style="display: none;"><img src="/static/kakaotalk.png" alt="KakaoTalk Share" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;">ì „ì²´ ê²°ê³¼ ê³µìœ í•˜ê¸°</button>
    <ins class="kakao_ad_area" style="display:none;"
    data-ad-unit = "DAN-GsHTuBiNm6Sz7qAw"
    data-ad-width = "300"
    data-ad-height = "250"></ins>
    <div class="footer">
      <p>&copy; 2025 ë¦¬ì–¼ë¼ì´íŠ¸ Realright. All Rights Reserved.</p>

    </div>
  </div>

  <!-- Occupancy Popup -->
  <div id="occupancy-popup" class="popup-overlay">
      <div class="popup">
          <h2>í˜„ì¬ ëª‡ ëª…ì´ ì‚¬ìš© ì˜ˆì •ì¸ê°€ìš”?</h2>
          <p>ì—¬ëŸ¬ë¶„ì˜ ì…ë ¥ì´ ë” ì •í™•í•œ ë¹ˆ ê°•ì˜ì‹¤ ì •ë³´ë¥¼ ë§Œë“œëŠ” ë°<br>í° ë„ì›€ì´ ë©ë‹ˆë‹¤!</p>
          <div class="popup-options">
              <div class="popup-option" data-range="1ëª…">1ëª…</div>
              <div class="popup-option" data-range="2ëª…">2ëª…</div>
              <div class="popup-option" data-range="3ëª…">3ëª…</div>
              <div class="popup-option" data-range="4ëª…">4ëª…</div>
              <div class="popup-option span-two-columns" data-range="5ëª… ì´ìƒ">5ëª… ì´ìƒ</div>
          </div>
          <button id="popup-submit-btn" class="popup-submit">ì¸ì› ì œì¶œí•˜ê¸°</button>
      </div>
  </div>

  <!-- Thank You Popup -->
  <div id="thanks-popup" class="popup-overlay">
      <div class="popup">
          <h2>ê¸°ì—¬í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤!</h2>
          <p>ë•ë¶„ì— HUFSpaceê°€ ë” ì •í™•í•´ì¡Œì–´ìš”!<br>ë‹¤ë¥¸ í•™ìš°ë¶„ë“¤ì—ê²Œë„ í° ë„ì›€ì´ ë©ë‹ˆë‹¤ ğŸ˜Š</p>
          <button id="thanks-popup-close-btn" class="popup-submit">í™•ì¸</button>
      </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const daySelect = document.getElementById('day-select');
        const startHourSelect = document.getElementById('start-hour-select');
        const startMinuteSelect = document.getElementById('start-minute-select');
        const endHourSelect = document.getElementById('end-hour-select');
        const endMinuteSelect = document.getElementById('end-minute-select');
        const searchBtn = document.getElementById('search-btn');
        const buildingCheckboxesDiv = document.getElementById('building-checkboxes');
        const resultsDiv = document.getElementById('results');

        // Popup elements
        const occupancyPopup = document.getElementById('occupancy-popup');
        const popupSubmitBtn = document.getElementById('popup-submit-btn');
        const popupOptions = document.querySelectorAll('.popup-option');
        const thanksPopup = document.getElementById('thanks-popup');
        const thanksPopupCloseBtn = document.getElementById('thanks-popup-close-btn');

        let currentClassroom = null;
        let selectedRange = null;
        let lastSubmittedTotal = null;

        const generateHourOptions = (selectElement) => {
            for (let h = 9; h <= 20; h++) {
                const option = document.createElement('option');
                option.value = String(h).padStart(2, '0');
                option.textContent = `${String(h).padStart(2, '0')}ì‹œ`;
                selectElement.appendChild(option);
            }
        };

        const generateMinuteOptions = (selectElement) => {
            for (let m = 0; m < 60; m += 10) {
                const option = document.createElement('option');
                option.value = String(m).padStart(2, '0');
                option.textContent = `${String(m).padStart(2, '0')}ë¶„`;
                selectElement.appendChild(option);
            }
        };

        generateHourOptions(startHourSelect);
        generateMinuteOptions(startMinuteSelect);
        generateHourOptions(endHourSelect);
        generateMinuteOptions(endMinuteSelect);

        startHourSelect.value = '10';
        startMinuteSelect.value = '00';
        endHourSelect.value = '11';
        endMinuteSelect.value = '00';

        const loadBuildings = async () => {
            const buildings = ["êµìˆ˜í•™ìŠµê°œë°œì›", "ëŒ€í•™ì›", "ë²•í•™ê´€", "ë³¸ê´€", "ì‚¬ì´ë²„ê´€", "ì‚¬íšŒê³¼í•™ê´€", "ì¸ë¬¸ê³¼í•™ê´€"];
            buildingCheckboxesDiv.innerHTML = '';
            buildings.forEach(building => {
                const card = document.createElement('div');
                card.className = 'building-card';
                card.dataset.building = building;
                card.textContent = building;
                card.addEventListener('click', () => card.classList.toggle('selected'));
                buildingCheckboxesDiv.appendChild(card);
            });
        };
        loadBuildings();

        // --- Popup Logic ---
        const openPopup = (classroom) => {
            currentClassroom = classroom;
            selectedRange = null;
            popupOptions.forEach(opt => opt.classList.remove('selected'));
            occupancyPopup.style.display = 'flex';
        };

        const closePopup = () => {
            occupancyPopup.style.display = 'none';
        };

        const openThanksPopup = () => {
            thanksPopup.style.display = 'flex';
        };

        const closeThanksPopup = () => {
            thanksPopup.style.display = 'none';
            if (currentClassroom && lastSubmittedTotal !== null) {
                const roomElement = document.querySelector(`[data-classroom-name="${currentClassroom}"]`);
                if (roomElement) {
                    const occupancyCountSpan = roomElement.querySelector('.occupancy-count');
                    if (occupancyCountSpan) {
                        occupancyCountSpan.textContent = lastSubmittedTotal;
                    }
                }
            }
        };

        popupOptions.forEach(option => {
            option.addEventListener('click', () => {
                popupOptions.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                selectedRange = option.dataset.range;
            });
        });

        popupSubmitBtn.addEventListener('click', async () => {
            if (!currentClassroom || !selectedRange) {
                alert("ì¸ì› ë²”ìœ„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            try {
                const response = await fetch('/occupancy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        classroom: currentClassroom,
                        count_range: selectedRange
                    })
                });
                const data = await response.json();
                if (data.success) {
                    lastSubmittedTotal = data.total_occupancy;
                    closePopup();
                    openThanksPopup();
                } else {
                    alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + data.error);
                }
            } catch (error) {
                console.error('Occupancy update error:', error);
                alert("ë°ì´í„° ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        });

        occupancyPopup.addEventListener('click', (e) => {
            if (e.target === occupancyPopup) closePopup();
        });
        thanksPopup.addEventListener('click', (e) => {
            if (e.target === thanksPopup) closeThanksPopup();
        });
        thanksPopupCloseBtn.addEventListener('click', closeThanksPopup);

        // --- Search Logic ---
        searchBtn.addEventListener('click', async () => {
            const day = daySelect.value;
            const startTime = `${startHourSelect.value}:${startMinuteSelect.value}`;
            const endTime = `${endHourSelect.value}:${endMinuteSelect.value}`;

            if (startTime >= endTime) {
                alert("ê³µê°• ì‹œê°„ëŒ€ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            
            const selectedBuildings = Array.from(document.querySelectorAll('.building-card.selected'))
                                            .map(card => card.dataset.building)
                                            .join(',');

            resultsDiv.innerHTML = '<div class="loading-spinner"></div>';

            try {
                const url = `/find?day=${day}&startTime=${startTime}&endTime=${endTime}&buildings=${selectedBuildings}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                resultsDiv.innerHTML = ''; 

                if (data.length === 0) {
                    alert("í•´ë‹¹ ê±´ë¬¼ì— ë¹ˆ ê°•ì˜ì‹¤ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                    resultsDiv.innerHTML = '';
                    document.getElementById('share-all-btn').style.display = 'none';
                } else {
                    data.sort((a, b) => {
                        const roomA = parseInt(a.classroom.match(/\d+/));
                        const roomB = parseInt(b.classroom.match(/\d+/));
                        return roomA - roomB;
                    });

                    let currentFloor = null;
                    let currentFloorRow = null;

                    data.forEach(room => {
                        const roomName = room.classroom;
                        const match = roomName.match(/\s(\d+)/);
                        let floor = 'N/A';
                        if (match && match[1]) {
                            floor = match[1].charAt(0);
                        }

                        if (floor !== currentFloor) {
                            currentFloor = floor;
                            if (resultsDiv.children.length > 0) {
                                const floorSeparator = document.createElement('hr');
                                floorSeparator.className = 'floor-separator';
                                resultsDiv.appendChild(floorSeparator);
                            }
                            currentFloorRow = document.createElement('div');
                            currentFloorRow.className = 'floor-row';
                            resultsDiv.appendChild(currentFloorRow);
                        }

                        const item = document.createElement('div');
                        item.className = 'result-item';
                        item.dataset.classroomName = room.classroom;

                        const nameContainer = document.createElement('div');
                        nameContainer.style.display = 'flex';
                        nameContainer.style.justifyContent = 'space-between';
                        nameContainer.style.width = '100%';
                        nameContainer.style.alignItems = 'center';

                        const nameSpan = document.createElement('div');
                        nameSpan.className = 'classroom-name';
                        nameSpan.textContent = room.classroom;

                        const shareButton = document.createElement('img');
                        shareButton.src = "/static/kakaotalk.png";
                        shareButton.alt = "KakaoTalk Share";
                        shareButton.style.width = "24px";
                        shareButton.style.height = "24px";
                        shareButton.style.cursor = "pointer";
                        
                        nameContainer.appendChild(nameSpan);
                        nameContainer.appendChild(shareButton);

                        const nextClassDiv = document.createElement('div');
                        nextClassDiv.className = 'next-class';
                        nextClassDiv.innerHTML = `ë‹¤ìŒ ê°•ì˜: <span class="next-class-time">${room.next_class}</span>`;

                        const occupancyDiv = document.createElement('div');
                        occupancyDiv.className = 'occupancy-info';
                        occupancyDiv.innerHTML = `ì§€ê¸ˆ ì´ìš© ì¤‘: <span class="occupancy-count">${room.occupancy || 0}</span>ëª…`;

                        const useButton = document.createElement('button');
                        useButton.className = 'use-classroom-btn';
                        useButton.textContent = 'ì´ ê°•ì˜ì‹¤ ì‚¬ìš©í•˜ê¸°';

                        item.appendChild(nameContainer);
                        item.appendChild(nextClassDiv);
                        item.appendChild(occupancyDiv);
                        item.appendChild(useButton);

                        // Event listeners
                        useButton.addEventListener('click', (e) => {
                            e.stopPropagation();
                            openPopup(room.classroom);
                        });

                        shareButton.addEventListener('click', (e) => {
                            e.stopPropagation();
                            Kakao.Link.sendDefault({
                                objectType: 'text',
                                text: `[HUFSpace]\n${room.classroom} ì§€ê¸ˆ ë¹„ì–´ìˆì–´ìš”!\në‹¤ìŒ ê°•ì˜: ${room.next_class} ğŸ“š`,
                                link: {
                                    mobileWebUrl: 'https://hufspace.onrender.com/',
                                    webUrl: 'https://hufspace.onrender.com/',
                                },
                            });
                        });

                        currentFloorRow.appendChild(item);
                    });

                    const shareAllBtn = document.getElementById('share-all-btn');
                    shareAllBtn.style.display = 'block';
                    shareAllBtn.onclick = () => {
                        const buildingText = selectedBuildings ? `${selectedBuildings} ê¸°ì¤€` : 'ì „ì²´ ê±´ë¬¼ ê¸°ì¤€';
                        let classroomList = data.map(r => r.classroom).join(', ');
                        Kakao.Link.sendDefault({
                            objectType: 'text',
                            text: `[HUFSpace]\n${startTime}~${endTime} ê³µê°•\n${buildingText} ì´ìš© ê°€ëŠ¥í•œ ê°•ì˜ì‹¤ ${data.length}ê°œ:\n${classroomList} ğŸ“š`,
                            link: {
                                mobileWebUrl: 'https://hufspace.onrender.com/',
                                webUrl: 'https://hufspace.onrender.com/',
                            },
                        });
                    };
                }
            } catch (error) {
                console.error('Fetch error:', error);
                resultsDiv.innerHTML = '<p class="no-results">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            }
        });
    });
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').then(registration => {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }, err => {
          console.log('ServiceWorker registration failed: ', err);
        });
      });
    }
  </script>
  <script type="text/javascript" src="//t1.daumcdn.net/kas/static/ba.min.js" async></script>
</body>
</html>
